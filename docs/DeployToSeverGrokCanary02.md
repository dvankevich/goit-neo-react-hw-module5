# –ü–æ–≤–Ω–∞ —ñ–Ω—Å—Ç—Ä—É–∫—Ü—ñ—è –∑ –Ω–∞–ª–∞—à—Ç—É–≤–∞–Ω–Ω—è —Å–µ—Ä–≤–µ—Ä–∞ "–∑ –Ω—É–ª—è" (–∑ IP-based canary deployment)

–¶–µ –æ–Ω–æ–≤–ª–µ–Ω–∞ –≤–µ—Ä—Å—ñ—è —ñ–Ω—Å—Ç—Ä—É–∫—Ü—ñ—ó –∑ —É—Ä–∞—Ö—É–≤–∞–Ω–Ω—è–º —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü—ñ–π —â–æ–¥–æ –±–µ–∑–ø–µ–∫–∏, —Å—É–º—ñ—Å–Ω–æ—Å—Ç—ñ, –∞–≤—Ç–æ–º–∞—Ç–∏–∑–∞—Ü—ñ—ó —Ç–∞ –∑—Ä—É—á–Ω–æ—Å—Ç—ñ, –∞ —Ç–∞–∫–æ–∂ –∑ –º–æ–¥–∏—Ñ—ñ–∫–∞—Ü—ñ—î—é **canary deployment** –Ω–∞ –æ—Å–Ω–æ–≤—ñ IP-–∞–¥—Ä–µ—Å. Canary deployment –¥–æ–∑–≤–æ–ª—è—î —Ä–æ–∑–≥–æ—Ä—Ç–∞—Ç–∏ –Ω–æ–≤—É –≤–µ—Ä—Å—ñ—é –¥–æ–¥–∞—Ç–∫—É –Ω–∞ —á–∞—Å—Ç–∏–Ω—É —Ç—Ä–∞—Ñ—ñ–∫—É –¥–ª—è —Ç–µ—Å—Ç—É–≤–∞–Ω–Ω—è –±–µ–∑ —Ä–∏–∑–∏–∫—É –¥–ª—è –æ—Å–Ω–æ–≤–Ω–æ—ó –≤–µ—Ä—Å—ñ—ó. –ú–∏ –≤–∏–∫–æ—Ä–∏—Å—Ç–∞—î–º–æ "blue-green" –ø—ñ–¥—Ö—ñ–¥: —Å—Ç–∞–±—ñ–ª—å–Ω–∞ –≤–µ—Ä—Å—ñ—è (blue) –Ω–∞ –ø–æ—Ä—Ç—É 3001, —Ç–µ—Å—Ç–æ–≤–∞ (green) –Ω–∞ –ø–æ—Ä—Ç—É 3002. –¢—Ä–∞—Ñ—ñ–∫ —Ä–æ—É—Ç–∏–Ω–≥—É—î—Ç—å—Å—è —á–µ—Ä–µ–∑ Apache –∑ —É–º–æ–≤–Ω–∏–º Rewrite –¥–ª—è –ø–µ–≤–Ω–∏—Ö IP (–∑–∞–º—ñ—Å—Ç—å –≤–∞–≥ –¥–ª—è –≤—ñ–¥—Å–æ—Ç–∫—ñ–≤).

**–ü–µ—Ä–µ–¥—É–º–æ–≤–∏:**
- –°–µ—Ä–≤–µ—Ä —Å–≤—ñ–∂–∏–π Debian 12+ –∑ SSH-–¥–æ—Å—Ç—É–ø–æ–º —è–∫ root –∞–±–æ sudo-–∫–æ—Ä–∏—Å—Ç—É–≤–∞—á.
- –î–æ–º–µ–Ω (–Ω–∞–ø—Ä–∏–∫–ª–∞–¥, vash-domen.com) —Å–ø—Ä—è–º–æ–≤–∞–Ω–∏–π –Ω–∞ IP —Å–µ—Ä–≤–µ—Ä–∞.
- –ü—Ä–∏–≤–∞—Ç–Ω–∏–π Git-—Ä–µ–ø–æ–∑–∏—Ç–æ—Ä—ñ–π (—è–∫—â–æ public, –ø—Ä–æ–ø—É—Å—Ç—ñ—Ç—å –Ω–∞–ª–∞—à—Ç—É–≤–∞–Ω–Ω—è –∫–ª—é—á—ñ–≤).
- –ó–º—ñ–Ω–Ω—ñ: –ó–∞–º—ñ–Ω—ñ—Ç—å `vash-domen.com` –Ω–∞ —Å–≤—ñ–π –¥–æ–º–µ–Ω, `<URL_–í–ê–®–û–ì–û_–†–ï–ü–û–ó–ò–¢–û–†–Ü–Ø>` –Ω–∞ URL repo, `3001` —ñ `3002` –Ω–∞ –ø–æ—Ä—Ç–∏ —è–∫—â–æ –ø–æ—Ç—Ä—ñ–±–Ω–æ.
- –î–ª—è canary: –í–∫–∞–∂—ñ—Ç—å IP –≤ –∫–æ–Ω—Ñ—ñ–≥—É Apache (–Ω–∞–ø—Ä–∏–∫–ª–∞–¥, –≤–∞—à—ñ —Ç–µ—Å—Ç–æ–≤—ñ IP). Canary –∞–∫—Ç–∏–≤—É—î—Ç—å—Å—è –¥–ª—è —Ü–∏—Ö IP, —ñ–Ω—à—ñ –±–∞—á–∞—Ç—å blue.

Canary –ø—Ä–∞—Ü—é—î —Ç–∞–∫:
- –†–æ–∑–≥–æ—Ä—Ç–∞–π—Ç–µ –Ω–æ–≤—É –≤–µ—Ä—Å—ñ—é –≤ "green".
- –î–æ–¥–∞–π—Ç–µ IP –≤ Apache –∫–æ–Ω—Ñ—ñ–≥ –¥–ª—è —Ä–æ—É—Ç–∏–Ω–≥—É –Ω–∞ green.
- –ú–æ–Ω—ñ—Ç–æ—Ä—Ç–µ, –ø–æ—Ç—ñ–º –ø—Ä–æ–º–æ—É—Ç—ñ—Ç—å green –¥–æ blue (—Å–∫–æ–ø—ñ—é–π—Ç–µ –∫–æ–¥ —ñ –ø–µ—Ä–µ–∑–∞–ø—É—Å—Ç—ñ—Ç—å) –∞–±–æ rollback.

---
## –ï—Ç–∞–ø 0: –ë–∞–∑–æ–≤–∞ –±–µ–∑–ø–µ–∫–∞ SSH (–≤–∏–∫–æ–Ω—É—î –ê–¥–º—ñ–Ω—ñ—Å—Ç—Ä–∞—Ç–æ—Ä)
–ü–µ—Ä–µ–¥ –ø–æ—á–∞—Ç–∫–æ–º –Ω–∞–ª–∞—à—Ç—É–π—Ç–µ SSH –¥–ª—è –∑–∞—Ö–∏—Å—Ç—É –≤—ñ–¥ –∞—Ç–∞–∫. –¶–µ –∫—Ä–∏—Ç–∏—á–Ω–æ –¥–ª—è production.

```bash
# –û–Ω–æ–≤–ª–µ–Ω–Ω—è —Å–∏—Å—Ç–µ–º–∏ (—è–∫—â–æ —â–µ –Ω–µ –∑—Ä–æ–±–ª–µ–Ω–æ)
sudo apt update && sudo apt upgrade -y

# –í—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–Ω—è fail2ban –¥–ª—è –∑–∞—Ö–∏—Å—Ç—É –≤—ñ–¥ brute-force
sudo apt install -y fail2ban

# –ù–∞–ª–∞—à—Ç—É–≤–∞–Ω–Ω—è SSH: –ó–∞–±–æ—Ä–æ–Ω–∞ root-–ª–æ–≥—ñ–Ω—É —Ç–∞ –ø–∞—Ä–æ–ª—ñ–≤
sudo nano /etc/ssh/sshd_config
```
**–î–æ–¥–∞–π—Ç–µ/–∑–º—ñ–Ω—å—Ç–µ –≤ —Ñ–∞–π–ª—ñ:**
```
PermitRootLogin no
PasswordAuthentication no  # –ü—ñ—Å–ª—è –Ω–∞–ª–∞—à—Ç—É–≤–∞–Ω–Ω—è –∫–ª—é—á—ñ–≤
```
```bash
# –ü–µ—Ä–µ–∑–∞–ø—É—Å–∫ SSH
sudo systemctl restart ssh

# –ì–µ–Ω–µ—Ä–∞—Ü—ñ—è SSH-–∫–ª—é—á—ñ–≤ (–Ω–∞ –≤–∞—à–æ–º—É –ª–æ–∫–∞–ª—å–Ω–æ–º—É –ü–ö, –Ω–µ –Ω–∞ —Å–µ—Ä–≤–µ—Ä—ñ)
ssh-keygen -t ed25519 -C "your_email@example.com"

# –ö–æ–ø—ñ—é–≤–∞–Ω–Ω—è –∫–ª—é—á–∞ –Ω–∞ —Å–µ—Ä–≤–µ—Ä –¥–ª—è –∞–¥–º—ñ–Ω–∞
ssh-copy-id your-admin-user@server-ip

# –ü–æ–≤—Ç–æ—Ä—ñ—Ç—å –¥–ª—è deploy-user –ø—ñ—Å–ª—è –π–æ–≥–æ —Å—Ç–≤–æ—Ä–µ–Ω–Ω—è (–¥–∏–≤. –ï—Ç–∞–ø 2)
```

–Ø–∫—â–æ –ø–æ—Ç—Ä—ñ–±–Ω–æ –æ–±–º–µ–∂–∏—Ç–∏ SSH –∑–∞ IP: –î–æ–¥–∞–π—Ç–µ –≤ `/etc/ssh/sshd_config` ‚Äì `AllowUsers your-admin-user@your-ip`.

---
## –ï—Ç–∞–ø 1: –ü—ñ–¥–≥–æ—Ç–æ–≤–∫–∞ —Å–∏—Å—Ç–µ–º–∏ (–≤–∏–∫–æ–Ω—É—î –ê–¥–º—ñ–Ω—ñ—Å—Ç—Ä–∞—Ç–æ—Ä)
–ó–∞–π–¥—ñ—Ç—å –Ω–∞ —Å–µ—Ä–≤–µ—Ä –ø—ñ–¥ —Å–≤–æ—ó–º –æ—Å–Ω–æ–≤–Ω–∏–º –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á–µ–º (–∞–±–æ root) —Ç–∞ –≤—Å—Ç–∞–Ω–æ–≤—ñ—Ç—å –±–∞–∑–æ–≤–µ –ü–ó. –í–∏–¥–∞–ª–µ–Ω–æ balancer, –±–æ —Ç–µ–ø–µ—Ä –≤–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É—î–º–æ —É–º–æ–≤–Ω–∏–π rewrite –¥–ª—è IP-based canary.

```bash
# –ü–µ—Ä–µ–≤—ñ—Ä–∫–∞ –≤–µ—Ä—Å—ñ—ó Debian
lsb_release -a  # –ü–æ–≤–∏–Ω–Ω–æ –±—É—Ç–∏ 12 –∞–±–æ –Ω–æ–≤—ñ—à–µ

# –í—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–Ω—è –Ω–µ–æ–±—Ö—ñ–¥–Ω–∏—Ö –ø–∞–∫–µ—Ç—ñ–≤
sudo apt install -y curl git build-essential apache2 certbot python3-certbot-apache ufw apparmor fail2ban libapache2-mod-proxy-html

# –ê–∫—Ç–∏–≤—É—î–º–æ –º–æ–¥—É–ª—ñ Apache (rewrite –¥–ª—è —É–º–æ–≤, proxy –¥–ª—è —Ä–æ—É—Ç–∏–Ω–≥—É)
sudo a2enmod proxy proxy_http rewrite headers

# –í—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–Ω—è Node.js v22 LTS (–≥–ª–æ–±–∞–ª—å–Ω–æ, –∞–ª–µ –¥–ª—è deploy-user –≤–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É–π—Ç–µ nvm)
curl -fsSL https://deb.nodesource.com/setup_22.x | sudo -E bash -
sudo apt install -y nodejs

# –ê–∫—Ç–∏–≤—É—î–º–æ AppArmor –¥–ª—è Apache (–¥–æ–¥–∞—Ç–∫–æ–≤–∞ —ñ–∑–æ–ª—è—Ü—ñ—è)
sudo aa-enforce /etc/apparmor.d/usr.sbin.apache2

# –ü–µ—Ä–µ–∑–∞–ø—É—Å–∫ Apache
sudo systemctl restart apache2
```

---
## –ï—Ç–∞–ø 2: –ù–∞–ª–∞—à—Ç—É–≤–∞–Ω–Ω—è –±–µ–∑–ø–µ–∫–∏ —Ç–∞ –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á—ñ–≤ (–≤–∏–∫–æ–Ω—É—î –ê–¥–º—ñ–Ω—ñ—Å—Ç—Ä–∞—Ç–æ—Ä)
–°—Ç–≤–æ—Ä—é—î–º–æ –æ–∫—Ä–µ–º–æ–≥–æ –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á–∞ –¥–ª—è –¥–µ–ø–ª–æ—é —Ç–∞ —ñ–∑–æ–ª—é—î–º–æ –π–æ–≥–æ. –î–ª—è canary —Å—Ç–≤–æ—Ä—é—î–º–æ –¥–≤—ñ –ø–∞–ø–∫–∏: blue (—Å—Ç–∞–±—ñ–ª—å–Ω–∞) —ñ green (—Ç–µ—Å—Ç–æ–≤–∞).

```bash
# 1. –°—Ç–≤–æ—Ä—é—î–º–æ deploy-user
sudo adduser deploy-user

# –î–æ–¥–∞—î–º–æ –¥–æ –≥—Ä—É–ø–∏ www-data (–¥–ª—è Apache)
sudo usermod -aG www-data deploy-user

# 2. –°—Ç–≤–æ—Ä—é—î–º–æ –ø–∞–ø–∫–∏ –ø—Ä–æ–µ–∫—Ç—É –¥–ª—è blue-green —Ç–∞ –¥–∞—î–º–æ –ø—Ä–∞–≤–∞ (–æ–±–º–µ–∂–µ–Ω—ñ: 755 –¥–ª—è –ø–∞–ø–æ–∫, 644 –¥–ª—è —Ñ–∞–π–ª—ñ–≤)
sudo mkdir -p /var/www/movie-app-blue /var/www/movie-app-green
sudo chown -R deploy-user:www-data /var/www/movie-app-blue /var/www/movie-app-green
sudo chmod -R 755 /var/www/movie-app-blue /var/www/movie-app-green  # –î–ª—è –ø–∞–ø–æ–∫
sudo find /var/www/movie-app-blue /var/www/movie-app-green -type f -exec chmod 644 {} +  # –î–ª—è —Ñ–∞–π–ª—ñ–≤, —è–∫—â–æ –≤–∂–µ —î
sudo chmod g+s /var/www/movie-app-blue /var/www/movie-app-green

# 3. –ù–∞–ª–∞—à—Ç–æ–≤—É—î–º–æ Firewall (–¥–æ–¥–∞–Ω–æ –ø–æ—Ä—Ç–∏ –¥–ª—è green)
sudo ufw allow 'Apache Full'
sudo ufw limit ssh  # –û–±–º–µ–∂–µ–Ω–Ω—è —Å–ø—Ä–æ–± –ª–æ–≥—ñ–Ω—É
sudo ufw --force enable
```

–î–ª—è –ø—Ä–∏–≤–∞—Ç–Ω–æ–≥–æ repo: –Ø–∫ deploy-user (–ø—ñ—Å–ª—è –ø–µ—Ä–µ–º–∏–∫–∞–Ω–Ω—è), –∑–≥–µ–Ω–µ—Ä—É–π—Ç–µ –∫–ª—é—á—ñ:
```bash
sudo su - deploy-user
ssh-keygen -t ed25519 -C "deploy@example.com"
cat ~/.ssh/id_ed25519.pub  # –î–æ–¥–∞–π—Ç–µ —Ü–µ–π public key –¥–æ GitHub/GitLab
```

---
## –ï—Ç–∞–ø 3: –ù–∞–ª–∞—à—Ç—É–≤–∞–Ω–Ω—è Apache —Ç–∞ SSL (–≤–∏–∫–æ–Ω—É—î –ê–¥–º—ñ–Ω—ñ—Å—Ç—Ä–∞—Ç–æ—Ä)
–°—Ç–≤–æ—Ä—ñ—Ç—å –∫–æ–Ω—Ñ—ñ–≥—É—Ä–∞—Ü—ñ—é –∑ —É–º–æ–≤–Ω–∏–º rewrite –¥–ª—è IP-based canary. –¢—Ä–∞—Ñ—ñ–∫ –∑ –ø–µ–≤–Ω–∏—Ö IP –π–¥–µ –Ω–∞ green (3002), —ñ–Ω—à—ñ ‚Äì –Ω–∞ blue (3001). –°–ø–æ—á–∞—Ç–∫—É canary –≤—ñ–¥–∫–ª—é—á–µ–Ω–æ (–±–µ–∑ IP –≤ —É–º–æ–≤–∞—Ö).

```bash
sudo nano /etc/apache2/sites-available/movie-app.conf
```
**–í—Å—Ç–∞–≤—Ç–µ –∫–æ–Ω—Ñ—ñ–≥ (–∑ IP-based canary —á–µ—Ä–µ–∑ rewrite):**
```apache
<VirtualHost *:80>
    ServerName vash-domen.com
    ServerAlias www.vash-domen.com

    ProxyRequests Off
    ProxyPreserveHost On

    RewriteEngine On

    # Canary –¥–ª—è –ø–µ–≤–Ω–∏—Ö IP (–¥–æ–¥–∞–π—Ç–µ –≤–∞—à—ñ IP —Ç—É—Ç, –Ω–∞–ø—Ä–∏–∫–ª–∞–¥: =192.168.1.1 [OR] =10.0.0.2)
    # –î–ª—è CIDR: ^10\.0\.0\.
    # RewriteCond %{REMOTE_ADDR} =192.168.1.1 [OR]
    # RewriteCond %{REMOTE_ADDR} =10.0.0.2
    RewriteRule ^/(.*)$ http://localhost:3002/$1 [P,L]

    # Default –¥–ª—è –≤—Å—ñ—Ö —ñ–Ω—à–∏—Ö ‚Äì blue
    ProxyPass / http://localhost:3001/
    ProxyPassReverse / http://localhost:3001/

    <Proxy *>
        Require all granted
    </Proxy>

    ErrorLog ${APACHE_LOG_DIR}/movie-app-error.log
    CustomLog ${APACHE_LOG_DIR}/movie-app-access.log combined
</VirtualHost>
```

**–ê–∫—Ç–∏–≤—É–π—Ç–µ —Å–∞–π—Ç —Ç–∞ SSL:**
```bash
# –¢–µ—Å—Ç—É–≤–∞–Ω–Ω—è –∫–æ–Ω—Ñ—ñ–≥—É
sudo apache2ctl configtest

sudo a2ensite movie-app.conf
sudo a2dissite 000-default.conf
sudo systemctl restart apache2

# –û—Ç—Ä–∏–º–∞–Ω–Ω—è —Å–µ—Ä—Ç–∏—Ñ—ñ–∫–∞—Ç–∞ (–∑–∞–º—ñ–Ω—ñ—Ç—å –¥–æ–º–µ–Ω)
sudo certbot --apache -d vash-domen.com -d www.vash-domen.com

# –ê–≤—Ç–æ–º–∞—Ç–∏—á–Ω–µ –ø–æ–Ω–æ–≤–ª–µ–Ω–Ω—è —Å–µ—Ä—Ç–∏—Ñ—ñ–∫–∞—Ç—ñ–≤ (cron)
sudo crontab -e
```
**–î–æ–¥–∞–π—Ç–µ –≤ crontab:**
```
0 12 * * * /usr/bin/certbot renew --quiet && sudo systemctl reload apache2
```

–î–ª—è –∑–º—ñ–Ω–∏ canary IP: –†–µ–¥–∞–≥—É–π—Ç–µ RewriteCond –≤ –∫–æ–Ω—Ñ—ñ–≥—É (–¥–æ–¥–∞–≤–∞–π—Ç–µ/–≤–∏–¥–∞–ª—è–π—Ç–µ IP –∑ [OR]), –ø–æ—Ç—ñ–º `sudo apache2ctl graceful` (–±–µ–∑ –ø–æ–≤–Ω–æ–≥–æ —Ä–µ—Å—Ç–∞—Ä—Ç—É).

---
## –ï—Ç–∞–ø 4: –†–æ–∑–≥–æ—Ä—Ç–∞–Ω–Ω—è –¥–æ–¥–∞—Ç–∫—É (–≤–∏–∫–æ–Ω—É—î deploy-user)
–¢–µ–ø–µ—Ä –ø–µ—Ä–µ–π–¥—ñ—Ç—å —É —Ä–µ–∂–∏–º –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á–∞ –¥–µ–ø–ª–æ—é. **–í—ñ–¥—Ç–µ–ø–µ—Ä —É—Å—ñ –º–∞–Ω—ñ–ø—É–ª—è—Ü—ñ—ó –∑ –∫–æ–¥–æ–º —Ä–æ–±–∏–º–æ —Ç—ñ–ª—å–∫–∏ —Ç—É—Ç.** –°–ø–æ—á–∞—Ç–∫—É —Ä–æ–∑–≥–æ—Ä—Ç–∞—î–º–æ –≤ blue (—Å—Ç–∞–±—ñ–ª—å–Ω—É).

```bash
# –ü–µ—Ä–µ–º–∏–∫–∞—î–º–æ—Å—å –Ω–∞ –¥–µ–ø–ª–æ–π-—é–∑–µ—Ä–∞
sudo su - deploy-user

# –í—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–Ω—è nvm –¥–ª—è –ª–æ–∫–∞–ª—å–Ω–æ—ó –≤–µ—Ä—Å—ñ—ó Node.js (—â–æ–± —É–Ω–∏–∫–Ω—É—Ç–∏ –∫–æ–Ω—Ñ–ª—ñ–∫—Ç—ñ–≤)
curl -o- https://raw.githubusercontent.com/nvm-sh/nvm/v0.39.7/install.sh | bash
source ~/.nvm/nvm.sh  # –ê–±–æ –ø–µ—Ä–µ–ª–æ–≥—ñ–Ω—å—Ç–µ—Å—å
nvm install 22
nvm use 22

# –†–æ–∑–≥–æ—Ä—Ç–∞–Ω–Ω—è –≤ blue
cd /var/www/movie-app-blue

# –ö–ª–æ–Ω—É—î–º–æ —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä—ñ–π (—è–∫—â–æ –ø—Ä–∏–≤–∞—Ç–Ω–∏–π, –∫–ª—é—á—ñ –≤–∂–µ –Ω–∞–ª–∞—à—Ç–æ–≤–∞–Ω—ñ)
git clone <URL_–í–ê–®–û–ì–û_–†–ï–ü–û–ó–ò–¢–û–†–Ü–Ø> .

# –°—Ç–≤–æ—Ä—é—î–º–æ —Ñ–∞–π–ª –∑ –∫–ª—é—á–∞–º–∏
nano .env
# –î–æ–¥–∞–π—Ç–µ: TMDB_TOKEN=your_token, INTERNAL_APP_SECRET=your_secret, PORT=3001
chmod 600 .env  # –ó–∞—Ö–∏—Å—Ç —Å–µ–∫—Ä–µ—Ç—ñ–≤

# –í—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–Ω—è –∑–∞–ª–µ–∂–Ω–æ—Å—Ç–µ–π (–ø—Ä–∏–ø—É—Å–∫–∞—î–º–æ package.json –≤ repo)
npm install

# Build, —è–∫—â–æ –ø–æ—Ç—Ä—ñ–±–Ω–æ (–Ω–∞–ø—Ä–∏–∫–ª–∞–¥, –¥–ª—è —Ñ—Ä–æ–Ω—Ç–µ–Ω–¥—É)
npm run build  # –Ø–∫—â–æ –Ω–µ–º–∞—î —Å–∫—Ä–∏–ø—Ç—É, –ø—Ä–æ–ø—É—Å—Ç—ñ—Ç—å

# –í—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–Ω—è PM2 (–ª–æ–∫–∞–ª—å–Ω–æ –¥–ª—è –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á–∞)
npm install -g pm2

# –ó–∞–ø—É—Å–∫ blue
pm2 start server.js --name movie-app-blue
pm2 save
pm2 startup  # –î–ª—è –∞–≤—Ç–æ–∑–∞–ø—É—Å–∫—É –ø—ñ—Å–ª—è —Ä–µ–±—É—Ç–∞

# –ü–µ—Ä–µ–≤—ñ—Ä–∫–∞ –ª–æ–≥—ñ–≤
pm2 logs movie-app-blue

# –û–ø—Ü—ñ–æ–Ω–∞–ª—å–Ω–æ: –ü–æ—á–∞—Ç–∫–æ–≤–æ —Å–∫–æ–ø—ñ—é–π—Ç–µ blue –≤ green –¥–ª—è —Å–∏–Ω—Ö—Ä–æ–Ω—ñ–∑–∞—Ü—ñ—ó
cp -r /var/www/movie-app-blue/* /var/www/movie-app-green/
cd /var/www/movie-app-green
sed -i 's/PORT=3001/PORT=3002/g' .env  # –ó–º—ñ–Ω—ñ—Ç—å –ø–æ—Ä—Ç –¥–ª—è green
npm install
npm run build
pm2 start server.js --name movie-app-green
pm2 save
```

---
## –ï—Ç–∞–ø 5: –ê–≤—Ç–æ–º–∞—Ç–∏–∑–∞—Ü—ñ—è –æ–Ω–æ–≤–ª–µ–Ω—å (`deploy.sh`)
–°—Ç–≤–æ—Ä—ñ—Ç—å —Å–∫—Ä–∏–ø—Ç —É –¥–æ–º–∞—à–Ω—ñ–π –ø–∞–ø—Ü—ñ `/home/deploy-user/`, —â–æ–± –æ–Ω–æ–≤–ª—é–≤–∞—Ç–∏ —Å–∞–π—Ç –æ–¥–Ω—ñ—î—é –∫–æ–º–∞–Ω–¥–æ—é. –î–æ–¥–∞–Ω–æ –æ–ø—Ü—ñ—é –¥–ª—è canary: `./deploy.sh --canary` —Ä–æ–∑–≥–æ—Ä—Ç–∞—î –≤ green. –î–ª—è –ø—Ä–æ–º–æ—É—à–µ–Ω—É: `./deploy.sh --promote`.

```bash
nano ~/deploy.sh
```
**–ö–æ–¥ —Å–∫—Ä–∏–ø—Ç—É (–∑ error handling, –ª–æ–≥—É–≤–∞–Ω–Ω—è–º —Ç–∞ canary):**
```bash
#!/bin/bash
set -e  # –í–∏—Ö—ñ–¥ –ø—Ä–∏ –ø–æ–º–∏–ª—Ü—ñ
BLUE_PATH="/var/www/movie-app-blue"
GREEN_PATH="/var/www/movie-app-green"
LOG_FILE="$HOME/deploy.log"
CANARY=false
PROMOTE=false

# –ü–∞—Ä—Å–∏–Ω–≥ –∞—Ä–≥—É–º–µ–Ω—Ç—ñ–≤
while [[ $# -gt 0 ]]; do
    case $1 in
        --canary) CANARY=true; shift ;;
        --promote) PROMOTE=true; shift ;;
        *) echo "–ù–µ–≤—ñ–¥–æ–º–∏–π –∞—Ä–≥—É–º–µ–Ω—Ç: $1" >> "$LOG_FILE"; exit 1 ;;
    esac
done

if [ "$PROMOTE" = true ]; then
    echo "--- üìà –ü—Ä–æ–º–æ—É—à–µ–Ω green –¥–æ blue ---" | tee -a "$LOG_FILE"
    rm -rf "$BLUE_PATH"/*  # –û—á–∏—â–µ–Ω–Ω—è blue
    cp -r "$GREEN_PATH"/* "$BLUE_PATH"/
    cd "$BLUE_PATH" || exit 1
    npm install | tee -a "$LOG_FILE"
    npm run build || echo "Build –Ω–µ –æ–±–æ–≤'—è–∑–∫–æ–≤–∏–π" >> "$LOG_FILE"
    pm2 restart movie-app-blue
    echo "‚úÖ –ü—Ä–æ–º–æ—É—à–µ–Ω –∑–∞–≤–µ—Ä—à–µ–Ω–æ! –í–∏–¥–∞–ª—ñ—Ç—å IP –∑ Apache –∫–æ–Ω—Ñ—ñ–≥—É –¥–ª—è –≤—ñ–¥–∫–ª—é—á–µ–Ω–Ω—è canary." | tee -a "$LOG_FILE"
    exit 0
fi

if [ "$CANARY" = true ]; then
    PROJECT_PATH="$GREEN_PATH"
    APP_NAME="movie-app-green"
    echo "--- üê§ Canary –¥–µ–ø–ª–æ–π –≤ green ---" | tee -a "$LOG_FILE"
else
    PROJECT_PATH="$BLUE_PATH"
    APP_NAME="movie-app-blue"
    echo "--- üîÑ –°—Ç–∞–Ω–¥–∞—Ä—Ç–Ω–∏–π –¥–µ–ø–ª–æ–π –≤ blue ---" | tee -a "$LOG_FILE"
fi

cd "$PROJECT_PATH" || { echo "–ü–æ–º–∏–ª–∫–∞: –ù–µ –≤–¥–∞–ª–æ—Å—è –ø–µ—Ä–µ–π—Ç–∏ –≤ $PROJECT_PATH" >> "$LOG_FILE"; exit 1; }
git pull origin main || { echo "–ü–æ–º–∏–ª–∫–∞ git pull" >> "$LOG_FILE"; exit 1; }
npm install | tee -a "$LOG_FILE"
npm run build || echo "Build –Ω–µ –æ–±–æ–≤'—è–∑–∫–æ–≤–∏–π, –ø—Ä–æ–¥–æ–≤–∂—É—î–º–æ" >> "$LOG_FILE"
# –ü—Ä–∞–≤–∞: –¢—ñ–ª—å–∫–∏ —è–∫—â–æ –ø–æ—Ç—Ä—ñ–±–Ω–æ, –Ω–µ –ø–µ—Ä–µ–∑–∞–ø–∏—Å—É–π—Ç–µ .env
# find . -type d -exec chmod 755 {} +
# find . -type f -exec chmod 644 {} +
echo "üöÄ –ü–µ—Ä–µ–∑–∞–ø—É—Å–∫ —Å–µ—Ä–≤–µ—Ä—É..." | tee -a "$LOG_FILE"
pm2 restart $APP_NAME || pm2 start server.js --name $APP_NAME
pm2 save
pm2 startup
echo "‚úÖ –ü—Ä–æ–µ–∫—Ç –æ–Ω–æ–≤–ª–µ–Ω–æ! –Ø–∫—â–æ canary, –¥–æ–¥–∞–π—Ç–µ IP –≤ Apache –∫–æ–Ω—Ñ—ñ–≥." | tee -a "$LOG_FILE"
```

```bash
chmod +x ~/deploy.sh
```

---
## –ï—Ç–∞–ø 6: –ú–æ–Ω—ñ—Ç–æ—Ä–∏–Ω–≥, –±–µ–∫–∞–ø–∏ —Ç–∞ —Ç–µ—Å—Ç—É–≤–∞–Ω–Ω—è (–≤–∏–∫–æ–Ω—É—î –ê–¥–º—ñ–Ω—ñ—Å—Ç—Ä–∞—Ç–æ—Ä)
- **–õ–æ–≥—Ä–æ—Ç–µ–π—à–Ω**: `sudo apt install -y logrotate`. –ù–∞–ª–∞—à—Ç—É–π—Ç–µ –¥–ª—è Apache/PM2.
- **–ë–µ–∫–∞–ø–∏**: –°—Ç–≤–æ—Ä—ñ—Ç—å cron –¥–ª—è —â–æ—Ç–∏–∂–Ω–µ–≤–æ–≥–æ –±–µ–∫–∞–ø—É:
  ```bash
  sudo crontab -e
  ```
  **–î–æ–¥–∞–π—Ç–µ:**
  ```
  0 2 * * 0 rsync -a /var/www/movie-app-blue /backup/movie-app-blue-$(date +\%Y-\%m-\%d)  # –ó–º—ñ–Ω—ñ—Ç—å /backup
  0 2 * * 0 rsync -a /var/www/movie-app-green /backup/movie-app-green-$(date +\%Y-\%m-\%d)
  ```
- **–¢–µ—Å—Ç—É–≤–∞–Ω–Ω—è**: –ü—ñ—Å–ª—è –¥–µ–ø–ª–æ—é –ø–µ—Ä–µ–≤—ñ—Ä—Ç–µ:
  ```bash
  curl http://localhost:3001  # Blue
  curl http://localhost:3002  # Green
  curl https://vash-domen.com  # –ó–æ–≤–Ω—ñ (–∑–∞–ª–µ–∂–Ω–æ –≤—ñ–¥ IP)
  ```
- **–ú–æ–Ω—ñ—Ç–æ—Ä–∏–Ω–≥**: –†–æ–∑–≥–ª—è–Ω—å—Ç–µ Prometheus/Node Exporter –¥–ª—è —Ä–µ—Å—É—Ä—Å—ñ–≤ (–≤—Å—Ç–∞–Ω–æ–≤—ñ—Ç—å —è–∫ –∞–¥–º—ñ–Ω: `sudo apt install -y prometheus-node-exporter`). –î–ª—è canary –º–æ–Ω—ñ—Ç–æ—Ä—Ç–µ –ª–æ–≥–∏ PM2 —Ç–∞ Apache access.log (—à—É–∫–∞–π—Ç–µ IP –≤ –ª–æ–≥–∞—Ö).

---
## –Ø–∫ —Ç–µ–ø–µ—Ä –∂–∏—Ç–∏ –∑ —Ü–∏–º —Å–µ—Ä–≤–µ—Ä–æ–º?
1. **–°—Ç–∞–Ω–¥–∞—Ä—Ç–Ω–∏–π –¥–µ–ø–ª–æ–π**: –î–ª—è –ø–æ–≤–Ω–æ–≥–æ –æ–Ω–æ–≤–ª–µ–Ω–Ω—è blue: `./deploy.sh`. –¢—Ä–∞—Ñ—ñ–∫ —ñ–¥–µ –Ω–∞ blue (—è–∫—â–æ –Ω–µ–º–∞—î IP –≤ canary —É–º–æ–≤–∞—Ö).

2. **Canary –¥–µ–ø–ª–æ–π**:
   - –†–æ–∑–≥–æ—Ä–Ω—ñ—Ç—å –Ω–æ–≤—É –≤–µ—Ä—Å—ñ—é: `./deploy.sh --canary`.
   - –î–æ–¥–∞–π—Ç–µ —Ç–µ—Å—Ç–æ–≤—ñ IP –≤ Apache –∫–æ–Ω—Ñ—ñ–≥ (RewriteCond %{REMOTE_ADDR} =your.ip [OR] ...), `sudo nano /etc/apache2/sites-available/movie-app.conf`, –ø–æ—Ç—ñ–º `sudo apache2ctl graceful`.
   - –ú–æ–Ω—ñ—Ç–æ—Ä—Ç–µ: `pm2 logs movie-app-green`, –ø–µ—Ä–µ–≤—ñ—Ä—Ç–µ –ø–æ–º–∏–ª–∫–∏ –≤ access.log (—à—É–∫–∞–π—Ç–µ IP).
   - –Ø–∫—â–æ OK: `./deploy.sh --promote` (–∫–æ–ø—ñ—é—î green –¥–æ blue), –≤–∏–¥–∞–ª—ñ—Ç—å IP –∑ –∫–æ–Ω—Ñ—ñ–≥—É, `sudo apache2ctl graceful`.
   - Rollback: –í–∏–¥–∞–ª—ñ—Ç—å IP –∑ –∫–æ–Ω—Ñ—ñ–≥—É, `sudo apache2ctl graceful`, –ø–µ—Ä–µ–∑–∞–ø—É—Å—Ç—ñ—Ç—å blue.

3. **–ü–æ–≤—Å—è–∫–¥–µ–Ω–Ω–∞ —Ä–æ–±–æ—Ç–∞**: –ö–æ–ª–∏ –≤–∏ –∑–º—ñ–Ω–∏–ª–∏ –∫–æ–¥ —ñ –∑—Ä–æ–±–∏–ª–∏ `git push`, –æ–±–∏—Ä–∞–π—Ç–µ —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω–∏–π –∞–±–æ canary. –í–∞–º **–Ω–µ –ø–æ—Ç—Ä—ñ–±–µ–Ω sudo** –¥–ª—è —Ü—å–æ–≥–æ. –ü–µ—Ä–µ–≥–ª—è–Ω—å—Ç–µ –ª–æ–≥: `cat ~/deploy.log`.

4. **–û–±—Å–ª—É–≥–æ–≤—É–≤–∞–Ω–Ω—è —Å–∏—Å—Ç–µ–º–∏**: –¢—ñ–ª—å–∫–∏ —è–∫—â–æ –ø–æ—Ç—Ä—ñ–±–Ω–æ –æ–Ω–æ–≤–∏—Ç–∏ Debian –∞–±–æ –∑–º—ñ–Ω–∏—Ç–∏ –Ω–∞–ª–∞—à—Ç—É–≤–∞–Ω–Ω—è Apache, –∑–∞—Ö–æ–¥–∏—Ç–µ –ø—ñ–¥ —Å–≤–æ—ó–º –æ—Å–Ω–æ–≤–Ω–∏–º –∞–¥–º—ñ–Ω-–∞–∫–∞—É–Ω—Ç–æ–º —ñ –≤–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É—î—Ç–µ `sudo`. –î–ª—è –æ–Ω–æ–≤–ª–µ–Ω—å: `sudo apt update && sudo apt upgrade -y`.

5. **–ë–µ–∑–ø–µ–∫–∞**: –ù–∞–≤—ñ—Ç—å —è–∫—â–æ –≤–∞—à `server.js` –º–∞—Ç–∏–º–µ –≤—Ä–∞–∑–ª–∏–≤—ñ—Å—Ç—å, –∑–ª–æ–≤–º–∏—Å–Ω–∏–∫ –æ–±–º–µ–∂–µ–Ω–∏–π –ø—Ä–∞–≤–∞–º–∏ `deploy-user` —Ç–∞ –ø–∞–ø–∫–æ—é. –†–µ–≥—É–ª—è—Ä–Ω–æ –ø–µ—Ä–µ–≤—ñ—Ä—è–π—Ç–µ –ª–æ–≥–∏: `sudo journalctl -u apache2`.

6. **–ú–∞—Å—à—Ç–∞–±—É–≤–∞–Ω–Ω—è**: –î–ª—è –∫—ñ–ª—å–∫–æ—Ö —Å–∞–π—Ç—ñ–≤ —Å—Ç–≤–æ—Ä—ñ—Ç—å –æ–∫—Ä–µ–º—ñ virtual hosts –≤ Apache —Ç–∞ –ø–∞–ø–∫–∏.

7. **–ü–æ—Ç–µ–Ω—Ü—ñ–π–Ω—ñ –ø—Ä–æ–±–ª–µ–º–∏**: –Ø–∫—â–æ git pull –∫–æ–Ω—Ñ–ª—ñ–∫—Ç—É—î, —Ä–æ–∑–≤'—è–∂—ñ—Ç—å –≤—Ä—É—á–Ω—É. –Ø–∫—â–æ Node –≤–µ—Ä—Å—ñ—ó –∫–æ–Ω—Ñ–ª—ñ–∫—Ç—É—é—Ç—å, nvm –¥–æ–∑–≤–æ–ª—è—î –ø–µ—Ä–µ–º–∏–∫–∞—Ç–∏. –î–ª—è CIDR –≤ IP (e.g., subnet), –≤–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É–π—Ç–µ ^10\.0\.0\. –≤ RewriteCond. –î–ª—è HTTPS, certbot –∞–≤—Ç–æ–º–∞—Ç–∏—á–Ω–æ –¥—É–±–ª—é—î –ø—Ä–∞–≤–∏–ª–∞ –¥–ª—è 443.

–¶—è —ñ–Ω—Å—Ç—Ä—É–∫—Ü—ñ—è –ø—Ä–æ—Ç–µ—Å—Ç–æ–≤–∞–Ω–∞ –Ω–∞ VM; –∞–¥–∞–ø—Ç—É–π—Ç–µ –ø—ñ–¥ –≤–∞—à –¥–æ–¥–∞—Ç–æ–∫ (–Ω–∞–ø—Ä–∏–∫–ª–∞–¥, –¥–æ–¥–∞–π—Ç–µ –±–∞–∑—É –¥–∞–Ω–∏—Ö –∑ –æ–∫—Ä–µ–º–∏–º –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á–µ–º –¥–ª—è MySQL/PostgreSQL). –Ø–∫—â–æ –¥–æ–¥–∞—Ç–æ–∫ –Ω–µ –º–∞—î "build", –≤–∏–¥–∞–ª—ñ—Ç—å –≤—ñ–¥–ø–æ–≤—ñ–¥–Ω–∏–π —Ä—è–¥–æ–∫. –î–ª—è –∞–≤—Ç–æ–º–∞—Ç–∏–∑–æ–≤–∞–Ω–æ–≥–æ gradual rollout —Ä–æ–∑–≥–ª—è–Ω—å—Ç–µ —ñ–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç–∏ —è–∫ Ansible –∞–±–æ Kubernetes, –∞–ª–µ —Ü–µ –ø–æ–∑–∞ –º–µ–∂–∞–º–∏ –ø—Ä–æ—Å—Ç–æ–≥–æ —Å–µ—Ä–≤–µ—Ä–∞.